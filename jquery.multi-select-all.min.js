/**
 * jquery.multi-select-all.js
 * Original work by mySociety
 * https://github.com/mysociety/jquery-multi-select
 * 
 * This logic was forked in order to be able to add an "All" option that can be passed when instantiated as well as an 
 * "onClose" callback function for whne the selection's menu listing is closed. If your multi-select element has an option 
 * to select all, you can set the "allOptionValue" to the string value of this option. 
 * 
 * When selecting this "All" option, all other options will be deselected. Upon selecting another option, the "All"
 * option will be deselected.
 * 
    For example:

    $('select').multiSelect({
        allOptionValue: "All",
        onClose: function() {
            alert("Menu closed!")
        }
    });
 */
!function(t){"use strict";var e="multiSelect",s={containerHTML:'<div class="multi-select-container">',menuHTML:'<div class="multi-select-menu">',buttonHTML:'<span class="multi-select-button">',menuItemsHTML:'<div class="multi-select-menuitems">',menuItemHTML:'<label class="multi-select-menuitem">',presetsHTML:'<div class="multi-select-presets">',modalHTML:void 0,menuItemTitleClass:"multi-select-menuitem--titled",activeClass:"multi-select-container--open",noneText:"-- Select --",allText:void 0,presets:void 0,positionedMenuClass:"multi-select-container--positioned",positionMenuWithin:void 0,viewportBottomGutter:20,menuMinHeight:200,allOptionValue:void 0,onClose:void 0};function n(n,i){this.element=n,this.$element=t(n),this.settings=t.extend({},s,i),this._defaults=s,this._name=e,this.init()}t.extend(n.prototype,{init:function(){this.checkSuitableInput(),this.findLabels(),this.constructContainer(),this.constructButton(),this.constructMenu(),this.constructModal(),this.setUpBodyClickListener(),this.setUpLabelsClickListener(),this.$element.hide()},checkSuitableInput:function(t){if(!1===this.$element.is("select[multiple]"))throw new Error("$.multiSelect only works on <select multiple> elements")},findLabels:function(){this.$labels=t('label[for="'+this.$element.attr("id")+'"]')},constructContainer:function(){this.$container=t(this.settings.containerHTML),this.$element.data("multi-select-container",this.$container),this.$container.insertAfter(this.$element),this.$menuItems=t(this.settings.menuItemsHTML)},constructButton:function(){var e=this;this.$button=t(this.settings.buttonHTML),this.$button.attr({role:"button","aria-haspopup":"true",tabindex:0,"aria-label":this.$labels.eq(0).text()}).on("keydown.multiselect",function(t){var s=t.which;if(13===s||32===s)t.preventDefault(),e.$button.click();else if(40===s){t.preventDefault(),e.menuShow(),(e.$presets||e.$menuItems).children(":first").focus()}else 27===s&&e.menuHide()}).on("click.multiselect",function(t){e.menuToggle()}).appendTo(this.$container),this.$element.on("change.multiselect",function(t){e.updateButtonContents(t.target.text)}),this.updateButtonContents()},updateButtonContents:function(e){var s=this,n=[],i=[];this.$element.find("option").each(function(){var e=t(this).text();n.push(e),t(this).is(":selected")&&e!=s.settings.allOptionValue&&i.push(t.trim(e))}),this.$button.empty(),0==i.length?this.$button.text(this.settings.noneText):i.length===n.length&&this.settings.allText?this.$button.text(this.settings.allText):void 0!==this.settings.allOptionValue&&e===this.settings.allOptionValue?(this.$element.find("option").each(function(){t(this).text()!=e&&t(this).prop("selected",!1)}),this.$button.empty(),this.$button.text(this.settings.allText||e),s.updateMenuItems()):(this.$element.find("option").each(function(){t(this).text()==s.settings.allOptionValue&&t(this).prop("selected",!1)}),s.updateMenuItems(),this.$button.text(i.join(", ")))},constructMenu:function(){var e=this;this.$menu=t(this.settings.menuHTML),this.$menu.attr({role:"menu"}).on("keyup.multiselect",function(t){27===t.which&&(e.menuHide(),e.$button.focus())}).appendTo(this.$container),this.constructMenuItems(),this.settings.presets&&this.constructPresets()},constructMenuItems:function(){var t=this;this.$menu.append(this.$menuItems),this.$element.on("change.multiselect",function(e,s){!0!==s&&t.updateMenuItems()}),this.updateMenuItems()},updateMenuItems:function(){var e=this;this.$menuItems.empty(),this.$element.children("optgroup,option").each(function(s,n){var i;"OPTION"===n.nodeName?(i=e.constructMenuItem(t(n),s),e.$menuItems.append(i)):e.constructMenuItemsGroup(t(n),s)})},upDown:function(e,s){var n=s.which;if(38===n){s.preventDefault();var i=t(s.currentTarget).prev();i.length?i.focus():this.$presets&&"menuitem"===e?this.$presets.children(":last").focus():this.$button.focus()}else if(40===n){s.preventDefault();var o=t(s.currentTarget).next();o.length||"menuitem"===e?o.focus():this.$menuItems.children(":first").focus()}},constructPresets:function(){var e=this;this.$presets=t(this.settings.presetsHTML),this.$menu.prepend(this.$presets),t.each(this.settings.presets,function(s,n){var i=e.$element.attr("name")+"_preset_"+s,o=t(e.settings.menuItemHTML).attr({for:i,role:"menuitem"}).text(" "+n.name).on("keydown.multiselect",e.upDown.bind(e,"preset")).appendTo(e.$presets);t("<input>").attr({type:"radio",name:e.$element.attr("name")+"_presets",id:i}).prependTo(o).on("change.multiselect",function(){e.$element.val(n.options),e.$element.trigger("change")})}),this.$element.on("change.multiselect",function(){e.updatePresets()}),this.updatePresets()},updatePresets:function(){var e=this;t.each(this.settings.presets,function(t,s){var n=e.$element.attr("name")+"_preset_"+t,i=e.$presets.find("#"+n);!function(t,e){if(t.length!=e.length)return!1;t.sort(),e.sort();for(var s=0;s<t.length;s++)if(t[s]!==e[s])return!1;return!0}(s.options||[],e.$element.val()||[])?i.prop("checked",!1):i.prop("checked",!0)})},constructMenuItemsGroup:function(e,s){var n=this;e.children("option").each(function(i,o){var u=n.constructMenuItem(t(o),s+"_"+i),l=n.settings.menuItemTitleClass;0!==i&&(l+="sr"),u.addClass(l).attr("data-group-title",e.attr("label")),n.$menuItems.append(u)})},constructMenuItem:function(e,s){var n=this.$element.attr("name")+"_"+s,i=t(this.settings.menuItemHTML).attr({for:n,role:"menuitem"}).on("keydown.multiselect",this.upDown.bind(this,"menuitem")).text(" "+e.text()),o=t("<input>").attr({type:"checkbox",id:n,value:e.val()}).prependTo(i);return e.is(":disabled")&&o.attr("disabled","disabled"),e.is(":selected")&&o.prop("checked","checked"),o.on("change.multiselect",function(){t(this).prop("checked")?e.prop("selected",!0):e.prop("selected",!1),e.trigger("change",[!0])}),i},constructModal:function(){var e=this;this.settings.modalHTML&&(this.$modal=t(this.settings.modalHTML),this.$modal.on("click.multiselect",function(){e.menuHide()}),this.$modal.insertBefore(this.$menu))},setUpBodyClickListener:function(){var e=this;t("html").on("click.multiselect",function(){e.menuHide()}),this.$container.on("click.multiselect",function(t){t.stopPropagation()})},setUpLabelsClickListener:function(){var t=this;this.$labels.on("click.multiselect",function(e){e.preventDefault(),e.stopPropagation(),t.menuToggle()})},menuShow:function(){if(t("html").trigger("click.multiselect"),this.$container.addClass(this.settings.activeClass),this.settings.positionMenuWithin&&this.settings.positionMenuWithin instanceof t){var e=this.$menu.offset().left+this.$menu.outerWidth(),s=this.settings.positionMenuWithin.offset().left+this.settings.positionMenuWithin.outerWidth();e>s&&(this.$menu.css("width",s-this.$menu.offset().left),this.$container.addClass(this.settings.positionedMenuClass))}var n=this.$menu.offset().top+this.$menu.outerHeight(),i=t(window).scrollTop()+t(window).height();n>i-this.settings.viewportBottomGutter?this.$menu.css({maxHeight:Math.max(i-this.settings.viewportBottomGutter-this.$menu.offset().top,this.settings.menuMinHeight),overflow:"scroll"}):this.$menu.css({maxHeight:"",overflow:""})},menuHide:function(){this.$container.hasClass(this.settings.activeClass)&&void 0!==this.settings.onClose&&this.settings.onClose(),this.$container.removeClass(this.settings.activeClass),this.$container.removeClass(this.settings.positionedMenuClass),this.$menu.css("width","auto")},menuToggle:function(){this.$container.hasClass(this.settings.activeClass)?this.menuHide():this.menuShow()}}),t.fn[e]=function(s){return this.each(function(){t.data(this,"plugin_"+e)||t.data(this,"plugin_"+e,new n(this,s))})}}(jQuery);